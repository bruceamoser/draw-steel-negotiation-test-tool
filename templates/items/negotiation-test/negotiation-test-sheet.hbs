<form class="negotiation-app negotiation-sheet" autocomplete="off">
  <header class="neg-sheet-header">
    <input type="text" class="neg-title-input" name="system.title"
      value="{{system.title}}" placeholder="{{item.name}}"
      {{#unless isGM}}disabled{{/unless}} />
    <span class="neg-status-badge">{{statusLabel}}</span>
  </header>

  <nav class="tabs" data-group="primary">
    <a class="item" data-tab="overview">Overview</a>
    <a class="item" data-tab="participants">Participants</a>
    <a class="item" data-tab="npc">NPC Profile</a>
    <a class="item" data-tab="actions">Actions</a>
  </nav>

  <section class="tab-content">

    {{!-- ================================================================
         OVERVIEW
         ================================================================ --}}
    <div class="tab" data-group="primary" data-tab="overview">
      <div class="neg-overview-layout">

        <div class="neg-section">
          <h3 class="neg-section-title">Overview</h3>
          <div class="neg-editor-wrap" data-field="system.setup.overview">
            {{#unless isGM}}<div class="editor-content">{{{enrichedOverview}}}</div>{{/unless}}
          </div>
        </div>

        <div class="neg-outcomes-grid">
          <div class="neg-section neg-outcome neg-outcome--success">
            <h4 class="neg-section-title">Success</h4>
            <div class="neg-editor-wrap" data-field="system.setup.outcomes.success">
              {{#unless isGM}}<div class="editor-content">{{{enrichedOutcomeSuccess}}}</div>{{/unless}}
            </div>
          </div>

          <div class="neg-section neg-outcome neg-outcome--partial">
            <h4 class="neg-section-title">Partial Success</h4>
            <div class="neg-editor-wrap" data-field="system.setup.outcomes.partialSuccess">
              {{#unless isGM}}<div class="editor-content">{{{enrichedOutcomePartialSuccess}}}</div>{{/unless}}
            </div>
          </div>

          <div class="neg-section neg-outcome neg-outcome--failure">
            <h4 class="neg-section-title">Failure</h4>
            <div class="neg-editor-wrap" data-field="system.setup.outcomes.failure">
              {{#unless isGM}}<div class="editor-content">{{{enrichedOutcomeFailure}}}</div>{{/unless}}
            </div>
          </div>
        </div>

      </div>
    </div>

    {{!-- ================================================================
         PARTICIPANTS
         ================================================================ --}}
    <div class="tab" data-group="primary" data-tab="participants">

      {{#if isGM}}
      <div class="neg-section neg-toolbar">
        <span class="neg-hint">Drag an Actor here, or use the buttons to add a placeholder. Only one NPC is allowed.</span>
        <div class="neg-toolbar-actions">
          <button type="button" class="neg-btn" data-action="addPcNoActor">
            <i class="fa-solid fa-plus"></i> Add PC
          </button>
          <button type="button" class="neg-btn" data-action="addNpcNoActor">
            <i class="fa-solid fa-plus"></i> Add NPC
          </button>
        </div>
      </div>
      {{/if}}

      {{#if participants.length}}
      <div class="neg-section">
        <table class="neg-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Kind</th>
              <th>Role</th>
              <th>Active</th>
              {{#if isGM}}<th></th>{{/if}}
            </tr>
          </thead>
          <tbody>
            {{#each participants}}
            <tr>
              <td>
                <input type="hidden"
                  name="system.participants.{{this.index}}.id"
                  value="{{this.id}}" />
                <input type="text"
                  name="system.participants.{{this.index}}.displayName"
                  value="{{this.displayName}}"
                  {{#unless ../isGM}}disabled{{/unless}} />
              </td>
              <td>
                <select class="neg-participant-kind"
                  name="system.participants.{{this.index}}.kind"
                  data-participant-id="{{this.id}}"
                  {{#unless ../isGM}}disabled{{/unless}}>
                  <option value="pc"  {{#if (eq this.kind "pc")}}selected{{/if}}>PC</option>
                  <option value="npc" {{#if (eq this.kind "npc")}}selected{{/if}}>NPC</option>
                </select>
              </td>
              <td>
                <input type="text"
                  name="system.participants.{{this.index}}.role"
                  value="{{this.role}}"
                  placeholder="Role (optional)"
                  {{#unless ../isGM}}disabled{{/unless}} />
              </td>
              <td class="neg-center">
                <input type="checkbox"
                  name="system.participants.{{this.index}}.isActive"
                  {{#if this.isActive}}checked{{/if}}
                  {{#unless ../isGM}}disabled{{/unless}} />
              </td>
              {{#if ../isGM}}
              <td>
                <button type="button" class="neg-btn neg-btn--icon"
                  data-action="removeParticipant"
                  data-participant-id="{{this.id}}" title="Remove">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </td>
              {{/if}}
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{else}}
      <div class="neg-section">
        <p class="neg-empty">No participants yet — drag Actors here or use the button above.</p>
      </div>
      {{/if}}

    </div>

    {{!-- ================================================================
         NPC PROFILE
         ================================================================ --}}
    <div class="tab" data-group="primary" data-tab="npc">

      {{#if selectedNpc}}
      <div class="neg-npc-layout">

        {{!-- Left: stats --}}
        <div class="neg-section">
          <h3 class="neg-section-title">{{selectedNpc.name}}</h3>

          {{#if isGM}}
          <div class="neg-stat-grid">
            <label>Interest</label>
            <div class="neg-stat-input-row">
              <input type="number"
                name="system.npcStateByParticipantId.{{selectedNpc.id}}.interest.value"
                value="{{selectedNpc.interest.value}}"
                min="{{selectedNpc.interest.min}}"
                max="{{selectedNpc.interest.max}}" />
              <span class="neg-range">{{selectedNpc.interest.min}}–{{selectedNpc.interest.max}}</span>
            </div>

            <label>Patience</label>
            <div class="neg-stat-input-row">
              <input type="number"
                name="system.npcStateByParticipantId.{{selectedNpc.id}}.patience.value"
                value="{{selectedNpc.patience.value}}"
                min="{{selectedNpc.patience.min}}"
                max="{{selectedNpc.patience.max}}" />
              <span class="neg-range">{{selectedNpc.patience.min}}–{{selectedNpc.patience.max}}</span>
            </div>

            <label>Current Offer</label>
            <span class="neg-offer-label">{{selectedNpc.offerLabel}}</span>
          </div>

          {{/if}}
        </div>

        {{!-- Right: motivations & pitfalls --}}
        <div class="neg-section">

          <h4 class="neg-section-title">Motivations</h4>
          <ul class="neg-trait-list">
            {{#each selectedNpc.motivations}}
            <li class="neg-trait-item">
              <span class="neg-trait-label">{{this.label}}</span>
              {{#if ../isGM}}
              <label class="neg-checkbox-label">
                <input type="checkbox"
                  data-npc-id="{{../selectedNpc.id}}" data-list="motivations" data-idx="{{@index}}"
                  {{#if this.isRevealed}}checked{{/if}} />
                Revealed
              </label>
              <button type="button" class="neg-btn neg-btn--icon"
                data-action="removeNpcMotivation" data-index="{{@index}}" title="Remove">
                <i class="fa-solid fa-times"></i>
              </button>
              {{/if}}
            </li>
            {{else}}
            <li class="neg-empty-item">None added.</li>
            {{/each}}
          </ul>

          {{#if isGM}}
          <div class="neg-add-row">
            <select data-key="neg-add-motivation">
              {{#each motivationOptions}}
              <option value="{{this.id}}">{{this.label}}</option>
              {{/each}}
            </select>
            <button type="button" class="neg-btn" data-action="addNpcMotivation">
              <i class="fa-solid fa-plus"></i> Add Motivation
            </button>
          </div>
          {{/if}}

          <hr class="neg-divider" />

          <h4 class="neg-section-title">Pitfalls</h4>
          <ul class="neg-trait-list">
            {{#each selectedNpc.pitfalls}}
            <li class="neg-trait-item">
              <span class="neg-trait-label">{{this.label}}</span>
              {{#if ../isGM}}
              <label class="neg-checkbox-label">
                <input type="checkbox"
                  data-npc-id="{{../selectedNpc.id}}" data-list="pitfalls" data-idx="{{@index}}"
                  {{#if this.isRevealed}}checked{{/if}} />
                Revealed
              </label>
              <button type="button" class="neg-btn neg-btn--icon"
                data-action="removeNpcPitfall" data-index="{{@index}}" title="Remove">
                <i class="fa-solid fa-times"></i>
              </button>
              {{/if}}
            </li>
            {{else}}
            <li class="neg-empty-item">None added.</li>
            {{/each}}
          </ul>

          {{#if isGM}}
          <div class="neg-add-row">
            <select data-key="neg-add-pitfall">
              {{#each pitfallOptions}}
              <option value="{{this.id}}">{{this.label}}</option>
              {{/each}}
            </select>
            <button type="button" class="neg-btn" data-action="addNpcPitfall">
              <i class="fa-solid fa-plus"></i> Add Pitfall
            </button>
          </div>
          {{/if}}

        </div>
      </div>

      {{else}}
      <div class="neg-section">
        <p class="neg-empty">No NPC participant. Add one on the Participants tab first.</p>
      </div>
      {{/if}}

    </div>

    {{!-- ================================================================
         ACTIONS
         ================================================================ --}}
    <div class="tab" data-group="primary" data-tab="actions">

      {{!-- NPC status bar: visible to all users --}}
      {{#if selectedNpc}}
      <div class="neg-npc-status-bar">
        <span class="neg-npc-status-name">{{selectedNpc.name}}</span>
        <span class="neg-npc-status-stat">
          Interest: <strong>{{selectedNpc.interest.value}}</strong>
        </span>
        <span class="neg-npc-status-stat">
          Patience: <strong>{{selectedNpc.patience.value}}</strong>
        </span>
        {{#if selectedNpc.offerLabel}}
        <span class="neg-npc-status-offer">{{selectedNpc.offerLabel}}</span>
        {{/if}}
      </div>
      {{/if}}

      {{#if isGM}}
      <div class="neg-actions-layout">

        {{!-- Left column: controls + entry forms --}}
        <div class="neg-forms-col">

          <div class="neg-section neg-controls-bar">
            {{#if isInProgress}}
            <button type="button" class="neg-btn neg-btn--danger" data-action="stopNegotiation">
              <i class="fa-solid fa-stop"></i> Stop
            </button>
            {{else}}
            <button type="button" class="neg-btn" data-action="startNegotiation">
              <i class="fa-solid fa-play"></i> Start
            </button>
            {{/if}}
            <button type="button" class="neg-btn" data-action="resolveNegotiation">
              <i class="fa-solid fa-flag-checkered"></i> Resolve
            </button>
            <button type="button" class="neg-btn" data-action="copySummary">
              <i class="fa-solid fa-copy"></i> Copy Summary
            </button>
          </div>

          {{!-- Add Argument --}}
          <div class="neg-section">
            <h4 class="neg-section-title">Add Argument</h4>
            <div class="neg-form-grid">
              <label>PC Acting</label>
              <select data-key="neg-arg-actor">
                <option value="">(select PC)</option>
                {{#each pcOptions}}
                <option value="{{this.id}}">{{this.label}}</option>
                {{/each}}
              </select>

              <label>Tier</label>
              <select data-key="neg-arg-tier">
                <option value="1">Tier 1 (≤11)</option>
                <option value="2" selected>Tier 2 (12–16)</option>
                <option value="3">Tier 3 (17+)</option>
              </select>

              <label>Argument Type</label>
              <select data-key="neg-arg-type">
                {{#each argumentTypeOptions}}
                <option value="{{this.id}}">{{this.label}}</option>
                {{/each}}
              </select>

              <label>Motivation Used</label>
              <select data-key="neg-arg-motivation">
                <option value="">— none —</option>
                {{#each selectedNpc.motivations}}
                <option value="{{this.id}}">{{this.label}}</option>
                {{/each}}
              </select>

              <label>Pitfall Triggered</label>
              <select data-key="neg-arg-pitfall">
                <option value="">— none —</option>
                {{#each selectedNpc.pitfalls}}
                <option value="{{this.id}}">{{this.label}}</option>
                {{/each}}
              </select>
            </div>
            <div class="neg-form-footer">
              <label class="neg-checkbox-label">
                <input type="checkbox" data-key="neg-arg-reveal" /> Reveal to players
              </label>
              <button type="button" class="neg-btn neg-btn--primary" data-action="addArgumentEntry">
                <i class="fa-solid fa-plus"></i> Add Argument
              </button>
            </div>
          </div>

          {{!-- Discover Motivation / Pitfall --}}
          <div class="neg-section">
            <h4 class="neg-section-title">Discover</h4>
            <div class="neg-form-grid">
              <label>PC Acting</label>
              <select data-key="neg-reveal-actor">
                <option value="">(select PC)</option>
                {{#each pcOptions}}
                <option value="{{this.id}}">{{this.label}}</option>
                {{/each}}
              </select>

              <label>Tier</label>
              <select data-key="neg-reveal-tier">
                <option value="1">Tier 1 (≤11)</option>
                <option value="2" selected>Tier 2 (12–16)</option>
                <option value="3">Tier 3 (17+)</option>
              </select>
            </div>
            <div class="neg-form-footer">
              <label class="neg-checkbox-label">
                <input type="checkbox" data-key="neg-reveal-to-players" />
                Reveal discovered detail to players
              </label>
              <button type="button" class="neg-btn neg-btn--primary" data-action="addRevealEntry">
                <i class="fa-solid fa-search"></i> Add Discovery
              </button>
            </div>
          </div>

        </div>

        {{!-- Right column: action log --}}
        <div class="neg-log-col">
          <div class="neg-section neg-log">
            <h4 class="neg-section-title">Action Log</h4>

            {{#if timeline.length}}
            {{#each timeline}}
            <div class="neg-log-segment">
              <div class="neg-log-segment-label">{{this.label}}</div>
              {{#each this.entries}}
              <div class="neg-log-entry">
                <div class="neg-log-entry-meta">
                  {{#if this.actorName}}
                  <span class="neg-log-actor">{{this.actorName}}</span>
                  {{/if}}
                  <span class="neg-log-type">{{this.entryType}}</span>
                  {{#if this.rollTier}}
                  <span class="neg-tier-badge">T{{this.rollTier}}</span>
                  {{/if}}
                  {{#if this.effectsText}}
                  <span class="neg-log-effects">→ {{this.effectsText}}</span>
                  {{/if}}
                </div>
              </div>
              {{else}}
              <p class="neg-empty">No entries yet.</p>
              {{/each}}
            </div>
            {{/each}}
            {{else}}
            <p class="neg-empty">No actions recorded. Use <em>Start</em> to begin.</p>
            {{/if}}

          </div>
        </div>

      </div>

      {{else}}
      {{!-- Player view: revealed entries only --}}
      <div class="neg-section">
        <h4 class="neg-section-title">Action Log</h4>
        {{#each timeline}}
        {{#each this.entries}}
        {{#if this.isRevealedToPlayers}}
        <div class="neg-log-entry neg-log-entry--player">
          <div class="neg-log-entry-meta">
            {{#if this.actorName}}<span class="neg-log-actor">{{this.actorName}}</span>{{/if}}
            <span class="neg-log-type">{{this.entryType}}</span>
            {{#if this.rollTier}}<span class="neg-tier-badge">T{{this.rollTier}}</span>{{/if}}
            {{#if this.effectsText}}<span class="neg-log-effects">→ {{this.effectsText}}</span>{{/if}}
          </div>
        </div>
        {{/if}}
        {{/each}}
        {{/each}}
      </div>
      {{/if}}

    </div>

  </section>
</form>
